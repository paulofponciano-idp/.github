name: Deploy
on:
  workflow_call:
    inputs:
      tag:
        description: "Set Docker Image Tag"
        required: true  
        type: string
      repository:
        description: "Set Repository Name"
        required: true  
        type: string
      url:
        description: "Set Project URL"
        required: true  
        type: string
      environment:
        description: "Set Project Environment"
        required: true  
        type: string
        
jobs: 
  deploy:
    name: Set Kustomize and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Kustomize
        uses: imranismail/setup-kustomize@v2
        with: 
          kustomize-version: v5.1.1

      - name: GitOps Checkout
        run: git clone https://github.com/paulofponciano-idp/gitops.git .

      - name: Update k8s kustomization
        run: |
          cd deployed_apps/${{ inputs.repository }}/overlays
          kustomize edit set image webgo=paulofponciano/${{ inputs.repository }}:${{ inputs.tag }}
          cat kustomization.yaml

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -am "actions change image tag"

      - name: Push
        uses: ad-m/github-push-action@master